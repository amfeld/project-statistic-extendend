<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Financial Snapshot List View -->
    <record id="view_project_financial_snapshot_list" model="ir.ui.view">
        <field name="name">project.financial.snapshot.list</field>
        <field name="model">project.financial.snapshot</field>
        <field name="arch" type="xml">
            <list string="Financial Snapshots" create="false" default_order="snapshot_date desc">
                <field name="currency_id" column_invisible="1"/>
                <field name="snapshot_date"/>
                <field name="period_label" string="Period"/>
                <field name="snapshot_type" widget="badge"
                       decoration-info="snapshot_type == 'monthly'"
                       decoration-success="snapshot_type == 'quarterly'"
                       decoration-warning="snapshot_type == 'manual'"/>
                <field name="project_id"/>
                <field name="customer_invoiced_amount_net" sum="Total Revenue"
                       widget="monetary" options="{'currency_field': 'currency_id'}" string="Revenue"/>
                <field name="total_costs_net" sum="Total Internal Costs"
                       widget="monetary" options="{'currency_field': 'currency_id'}" string="Internal Costs"/>
                <field name="vendor_bills_total_net" sum="Total Vendor Bills"
                       widget="monetary" options="{'currency_field': 'currency_id'}" string="Vendor Bills"/>
                <field name="profit_loss_net" sum="Total P/L"
                       widget="monetary" options="{'currency_field': 'currency_id'}"
                       decoration-success="profit_loss_net > 0"
                       decoration-danger="profit_loss_net &lt; 0"
                       string="Profit/Loss"/>
                <field name="total_hours_booked" sum="Total Hours" string="Hours"/>
                <field name="revenue_delta" optional="hide" string="Revenue Change"
                       widget="monetary" options="{'currency_field': 'currency_id'}"
                       decoration-success="revenue_delta > 0"
                       decoration-danger="revenue_delta &lt; 0"/>
                <field name="profit_delta" optional="hide" string="Profit Change"
                       widget="monetary" options="{'currency_field': 'currency_id'}"
                       decoration-success="profit_delta > 0"
                       decoration-danger="profit_delta &lt; 0"/>
                <field name="monthly_burn_rate" optional="hide" string="Burn Rate"
                       widget="monetary" options="{'currency_field': 'currency_id'}"/>
            </list>
        </field>
    </record>

    <!-- Financial Snapshot Form View -->
    <record id="view_project_financial_snapshot_form" model="ir.ui.view">
        <field name="name">project.financial.snapshot.form</field>
        <field name="model">project.financial.snapshot</field>
        <field name="arch" type="xml">
            <form string="Financial Snapshot" create="false" edit="false">
                <sheet>
                    <div class="oe_title">
                        <h1><field name="display_name" readonly="1"/></h1>
                    </div>

                    <group col="4">
                        <field name="project_id"/>
                        <field name="snapshot_date"/>
                        <field name="snapshot_type" widget="badge"/>
                        <field name="period_label"/>
                    </group>

                    <notebook>
                        <page string="Revenue" name="revenue">
                            <group col="2">
                                <group string="Customer Invoices (NET)">
                                    <field name="customer_invoiced_amount_net" widget="monetary"/>
                                    <field name="customer_paid_amount_net" widget="monetary"/>
                                    <field name="customer_outstanding_amount_net" widget="monetary"/>
                                </group>
                                <group string="Sales Orders">
                                    <field name="sale_order_amount_net" widget="monetary"/>
                                </group>
                            </group>
                        </page>

                        <page string="Costs" name="costs">
                            <group col="2">
                                <group string="Vendor Bills">
                                    <field name="vendor_bills_total_net" widget="monetary"/>
                                    <field name="adjusted_vendor_bill_amount" widget="monetary"/>
                                </group>
                                <group string="Labor Costs">
                                    <field name="total_hours_booked"/>
                                    <field name="total_hours_booked_adjusted"/>
                                    <field name="labor_costs" widget="monetary"/>
                                    <field name="labor_costs_adjusted" widget="monetary"/>
                                </group>
                                <group string="Other Costs">
                                    <field name="other_costs_net" widget="monetary"/>
                                    <field name="total_costs_net" widget="monetary"/>
                                </group>
                                <group string="Discounts">
                                    <field name="customer_skonto_taken" widget="monetary"/>
                                    <field name="vendor_skonto_received" widget="monetary"/>
                                </group>
                            </group>
                        </page>

                        <page string="Profitability" name="profitability">
                            <group col="2">
                                <group string="Profit/Loss">
                                    <field name="profit_loss_net" widget="monetary"
                                           decoration-success="profit_loss_net > 0"
                                           decoration-danger="profit_loss_net &lt; 0"/>
                                    <field name="current_calculated_profit_loss" widget="monetary"/>
                                    <field name="negative_difference_net" widget="monetary"/>
                                </group>
                                <group string="Delta (vs Previous Period)">
                                    <field name="revenue_delta" widget="monetary"
                                           decoration-success="revenue_delta > 0"
                                           decoration-danger="revenue_delta &lt; 0"/>
                                    <field name="costs_delta" widget="monetary"/>
                                    <field name="profit_delta" widget="monetary"
                                           decoration-success="profit_delta > 0"
                                           decoration-danger="profit_delta &lt; 0"/>
                                    <field name="hours_delta"/>
                                </group>
                            </group>
                        </page>

                        <page string="Projections" name="projections">
                            <group col="2">
                                <group string="Burn Rate Analysis">
                                    <field name="monthly_burn_rate" widget="monetary"/>
                                    <field name="estimated_completion_cost" widget="monetary"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Financial Snapshot Pivot View -->
    <record id="view_project_financial_snapshot_pivot" model="ir.ui.view">
        <field name="name">project.financial.snapshot.pivot</field>
        <field name="model">project.financial.snapshot</field>
        <field name="arch" type="xml">
            <pivot string="Financial Snapshots Pivot">
                <field name="project_id" type="row"/>
                <field name="period_label" type="col"/>
                <field name="customer_invoiced_amount_net" type="measure"/>
                <field name="profit_loss_net" type="measure"/>
                <field name="total_hours_booked" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Financial Snapshot Graph View - Trend Analysis -->
    <record id="view_project_financial_snapshot_graph" model="ir.ui.view">
        <field name="name">project.financial.snapshot.graph</field>
        <field name="model">project.financial.snapshot</field>
        <field name="arch" type="xml">
            <graph string="Financial Trend" type="line" sample="1">
                <field name="snapshot_date" interval="month"/>
                <field name="customer_invoiced_amount_net" type="measure" string="Revenue"/>
                <field name="total_costs_net" type="measure" string="Internal Costs"/>
                <field name="vendor_bills_total_net" type="measure" string="Vendor Bills"/>
                <field name="profit_loss_net" type="measure" string="Profit/Loss"/>
            </graph>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_project_financial_snapshot_search" model="ir.ui.view">
        <field name="name">project.financial.snapshot.search</field>
        <field name="model">project.financial.snapshot</field>
        <field name="arch" type="xml">
            <search string="Search Snapshots">
                <field name="project_id"/>
                <field name="period_label"/>
                <filter string="Monthly" name="monthly" domain="[('snapshot_type', '=', 'monthly')]"/>
                <filter string="Quarterly" name="quarterly" domain="[('snapshot_type', '=', 'quarterly')]"/>
                <filter string="Manual" name="manual" domain="[('snapshot_type', '=', 'manual')]"/>
                <separator/>
                <filter string="Profitable" name="profitable" domain="[('profit_loss_net', '>', 0)]"/>
                <filter string="Loss-making" name="loss" domain="[('profit_loss_net', '&lt;', 0)]"/>
                <separator/>
                <filter string="This Year" name="this_year"
                        domain="[('snapshot_date', '>=', (context_today()).strftime('%Y-01-01'))]"/>
                <filter string="Last 12 Months" name="last_12_months"
                        domain="[('snapshot_date', '>=', (context_today() - relativedelta(months=12)).strftime('%Y-%m-%d'))]"/>
                <group expand="0" string="Group By">
                    <filter string="Project" name="group_project" context="{'group_by': 'project_id'}"/>
                    <filter string="Period Type" name="group_type" context="{'group_by': 'snapshot_type'}"/>
                    <filter string="Month" name="group_month" context="{'group_by': 'snapshot_date:month'}"/>
                    <filter string="Quarter" name="group_quarter" context="{'group_by': 'snapshot_date:quarter'}"/>
                    <filter string="Year" name="group_year" context="{'group_by': 'snapshot_date:year'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Window Action for Financial Snapshots -->
    <record id="action_project_financial_snapshot" model="ir.actions.act_window">
        <field name="name">Financial Snapshots</field>
        <field name="res_model">project.financial.snapshot</field>
        <field name="view_mode">list,pivot,graph,form</field>
        <field name="context">{'search_default_last_12_months': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">No financial snapshots yet</p>
            <p>Financial snapshots are created automatically (monthly/quarterly) or manually to track project performance over time.</p>
        </field>
    </record>

    <!-- Action to create manual snapshot from project -->
    <record id="action_create_snapshot_wizard" model="ir.actions.server">
        <field name="name">Create Financial Snapshot</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="binding_model_id" ref="project.model_project_project"/>
        <field name="binding_view_types">form,list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    snapshot_model = env['project.financial.snapshot']
    for project in records:
        if project.has_analytic_account:
            snapshot_model.create_snapshot(project, 'manual')
    action = {
        'type': 'ir.actions.client',
        'tag': 'display_notification',
        'params': {
            'title': 'Snapshot Created',
            'message': f'Financial snapshot created for {len(records)} project(s).',
            'type': 'success',
            'sticky': False,
        }
    }
        </field>
    </record>

    <!-- Cron Jobs for Automatic Snapshots -->
    <record id="ir_cron_monthly_snapshot" model="ir.cron">
        <field name="name">Create Monthly Financial Snapshots</field>
        <field name="model_id" ref="model_project_financial_snapshot"/>
        <field name="state">code</field>
        <field name="code">model.create_monthly_snapshots()</field>
        <field name="interval_number">1</field>
        <field name="interval_type">months</field>
        <field name="active" eval="True"/>
    </record>

    <record id="ir_cron_quarterly_snapshot" model="ir.cron">
        <field name="name">Create Quarterly Financial Snapshots</field>
        <field name="model_id" ref="model_project_financial_snapshot"/>
        <field name="state">code</field>
        <field name="code">model.create_quarterly_snapshots()</field>
        <field name="interval_number">3</field>
        <field name="interval_type">months</field>
        <field name="active" eval="True"/>
    </record>

    <!-- Menu item under Project Statistics -->
    <menuitem id="menu_project_financial_snapshots"
              name="Financial Timeline"
              parent="menu_project_analytics_accounting"
              action="action_project_financial_snapshot"
              sequence="20"
              groups="account.group_account_readonly"/>
</odoo>
